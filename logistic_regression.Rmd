---
title: "Logistic Regression Model"
---

# Load library
```{r}
library(openxlsx)
library(randomForest)
library(caret)
library(ggplot2)
library(broom)
```

# Load data
```{r}
df <- read.xlsx("final_merged_generalised_dataset.xlsx")
head(df)
dim(df)

# Check number of longcov poeple
sum(df$longcov == 1)
```

# Data Cleaning

## Check the number of null values
```{r}
colSums(is.na(df))
```
## Check proportion of long covid people
```{r}
prop_longcov <- mean(df$longcov == 1, na.rm = TRUE)

# Calculate proportions AFTER REMOVING missing FINAL_WGHT and HSLEEPPP
prop_longcov_no_missing_weight <- mean(df$longcov[!is.na(df$FINAL_WGHT)] == 1, na.rm = TRUE)
prop_longcov_no_missing_sleep_pre <- mean(df$longcov[!is.na(df$HSLEEPPP_pre)] == 1, na.rm = TRUE)
prop_longcov_no_missing_sleep_post <- mean(df$longcov[!is.na(df$HSLEEPSP_post)] == 1, na.rm = TRUE)
prop_longcov_no_missing_HH <- mean(df$longcov[!is.na(df$HHNUM)] == 1, na.rm = TRUE)
prop_longcov_no_missing_excise_pre <- mean(df$longcov[!is.na(df$EXCISEPP_pre)] == 1, na.rm = TRUE)
prop_longcov_no_missing_excise_post <- mean(df$longcov[!is.na(df$EXCISESP_post)] == 1, na.rm = TRUE)
prop_longcov_no_missing_fruit_pre <- mean(df$longcov[!is.na(df$FRTVEGPP_pre)] == 1, na.rm = TRUE)
prop_longcov_no_missing_fruit_post <- mean(df$longcov[!is.na(df$FRTVEGSP_post)] == 1, na.rm = TRUE)

plot_data <- data.frame(
  Group = c(
    "Entire Sample",
    "Complete FINAL_WGHT",
    "Complete HSLEEPPP_pre",
    "Complete HSLEEPSP_post",
    "Complete HHNUM",
    "Complete EXCISEPP_pre",
    "Complete EXCISESP_post",
    "Complete FRTVEGPP_pre",
    "Complete FRTVEGSP_post"
  ),
  Proportion = c(
    prop_longcov,
    prop_longcov_no_missing_weight,
    prop_longcov_no_missing_sleep_pre,
    prop_longcov_no_missing_sleep_post,
    prop_longcov_no_missing_HH,
    prop_longcov_no_missing_excise_pre,
    prop_longcov_no_missing_excise_post,
    prop_longcov_no_missing_fruit_pre,
    prop_longcov_no_missing_fruit_post
  )
)

plot_data
```

## Remove predictors
```{r}
# remove predictors containing COVIDSYMPT, FATGRID, TIREDGRID, AND COVNEWILT
df <- df[ , !grepl("COVIDSYMPT", names(df))]
df <- df[ , !grepl("FATGRID", names(df))]
df <- df[ , !grepl("TIREDGRID", names(df))]
df <- df[ , !grepl("COVNEWILT", names(df))]

# remove predictors with too many missing values
df <- df[, !(names(df) %in% "ID")]
df <- df[, !(names(df) %in% "RELSAT")]
df <- df[, !(names(df) %in% "GROWB2_post")]
df <- df[, !(names(df) %in% "CW3_GROWB2")]
df <- df[, !(names(df) %in% "FINAL_WGHT")]
df <- df[, !(names(df) %in% "HSLEEPPP_pre")]
df <- df[, !(names(df) %in% "HSLEEPSP_post")]
df <- df[, !(names(df) %in% "WRKHOURSB_pre")]
df <- df[, !(names(df) %in% "WRKHOURSD_post")]

# remove predictors related to COVID symptoms
df <- df[, !(names(df) %in% "CW3_COVID19")]
df <- df[, !(names(df) %in% "CW3_COVID19POS")]
df <- df[, !(names(df) %in% "CW3_MEMORY")]
df <- df[, !(names(df) %in% "CW3_SKIN")]
df <- df[, !(names(df) %in% "CW3_SHORTB")]
df <- df[, !(names(df) %in% "CW3_PALP")]
df <- df[, !(names(df) %in% "CW3_ACTIVITY")]
df <- df[, !(names(df) %in% "CW3_COVNEWILL")]

colSums(is.na(df))
```

## Check unique values in each column
```{r}
lapply(df, unique)
```

## Replace or turn missing values into a factor
```{r}
# set missing values for number of cigarettes as 0
df$NUMCIGSPP_pre[is.na(df$NUMCIGSPP_pre)] <- 0
df$NUMCIGSSP_post[is.na(df$NUMCIGSSP_post)] <- 0

# convert variables into factor
df$CW3_COHORT <- factor(df$CW3_COHORT)
df$PSEX <- factor(df$PSEX)
df$CW3_COVID_HOSPAD <- factor(df$CW3_COVID_HOSPAD)
df$longcov <- factor(df$longcov)

# convert NA to a missing level
vars_to_convert <- c("CW3_BEENVAC", "GHQ", "PMED", "CW3_ECONACTIVITYB2", "GHQPRECOVID_pre", "LLI_17_pre", "OUTDOORS_4_pre", "FINANCIALMANB_pre", "ECONACTIVITYB_pre", "SMOKING_pre", "VAPE_pre", "ALDRPP_pre", "FINANCIALMAND_post", "ECONACTIVITYD_post", "VAPESP_post", "ALDRSP_post", "SATN_post", "MHNOW_post")

for (var in vars_to_convert) {
  df[[var]] <- factor(df[[var]], exclude = NULL)
  levels(df[[var]])[is.na(levels(df[[var]]))] <- "Missing"
}

# check unique values
lapply(df, unique)
```

## Remove remaining missing values
```{r}
df_complete <- df[complete.cases(df), ]

dim(df_complete)
colSums(is.na(df_complete))

# Check number of longcov poeple
sum(df_complete$longcov == 1)
```

# Logistic regression

## Model
```{r}
log_mod <- glm(longcov ~ . , data = df_complete, family = binomial)

summary(log_mod)
```

# Output result

## Export missing values as csv file
```{r}
missing_counts <- colSums(is.na(df))
missing_df <- data.frame(
  Variable = names(missing_counts),
  Missing_Count = as.numeric(missing_counts)
)

print(missing_df)

write.csv(missing_df, "missing_values_summary.csv", row.names = FALSE)
```

## Export logistic regression result as csv file
```{r}
tidy_output <- tidy(log_mod)
print(tidy_output)

# round to 3 decimal places
tidy_output_rounded <- tidy_output
tidy_output_rounded$estimate <- round(tidy_output$estimate, 3)
tidy_output_rounded$std.error <- round(tidy_output$std.error, 3)
tidy_output_rounded$statistic <- round(tidy_output$statistic, 3)
tidy_output_rounded$p.value <- round(tidy_output$p.value, 3)

# export to CSV
write.csv(tidy_output_rounded, "logistic_regression_output.csv", row.names = FALSE)
```


