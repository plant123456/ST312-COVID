---
title: "Machine Learning Methods"
---

# Load library
```{r}
library(openxlsx)
library(randomForest)
library(caret)
library(ggplot2)
```

# Load data
```{r}
df <- read.xlsx("final_merged_generalised_dataset2.xlsx")
head(df)
```

# Data Cleaning

## Check the number of null values
```{r}
colSums(is.na(df))
```
## Check proportion of long covid people
```{r}
prop_longcov <- mean(df$longcov == 1, na.rm = TRUE)

# Calculate proportions AFTER REMOVING missing FINAL_WGHT and HSLEEPPP
prop_longcov_no_missing_weight <- mean(df$longcov[!is.na(df$FINAL_WGHT)] == 1, na.rm = TRUE)
prop_longcov_no_missing_sleep_pre <- mean(df$longcov[!is.na(df$HSLEEPPP_pre)] == 1, na.rm = TRUE)
prop_longcov_no_missing_sleep_post <- mean(df$longcov[!is.na(df$HSLEEPSP_post)] == 1, na.rm = TRUE)
prop_longcov_no_missing_HH <- mean(df$longcov[!is.na(df$HHNUM)] == 1, na.rm = TRUE)
prop_longcov_no_missing_excise_pre <- mean(df$longcov[!is.na(df$EXCISEPP_pre)] == 1, na.rm = TRUE)
prop_longcov_no_missing_excise_post <- mean(df$longcov[!is.na(df$EXCISESP_post)] == 1, na.rm = TRUE)
prop_longcov_no_missing_fruit_pre <- mean(df$longcov[!is.na(df$FRTVEGPP_pre)] == 1, na.rm = TRUE)
prop_longcov_no_missing_fruit_post <- mean(df$longcov[!is.na(df$FRTVEGSP_post)] == 1, na.rm = TRUE)

plot_data <- data.frame(
  Group = c(
    "Entire Sample",
    "Complete FINAL_WGHT",
    "Complete HSLEEPPP_pre",
    "Complete HSLEEPSP_post",
    "Complete HHNUM",
    "Complete EXCISEPP_pre",
    "Complete EXCISESP_post",
    "Complete FRTVEGPP_pre",
    "Complete FRTVEGSP_post"
  ),
  Proportion = c(
    prop_longcov,
    prop_longcov_no_missing_weight,
    prop_longcov_no_missing_sleep_pre,
    prop_longcov_no_missing_sleep_post,
    prop_longcov_no_missing_HH,
    prop_longcov_no_missing_excise_pre,
    prop_longcov_no_missing_excise_post,
    prop_longcov_no_missing_fruit_pre,
    prop_longcov_no_missing_fruit_post
  )
)

plot_data
```

## Remove predictors
```{r}
# remove predictors containing COVIDSYMPT, FATGRID, TIREDGRID, AND COVNEWILT
df <- df[ , !grepl("COVIDSYMPT", names(df))]
df <- df[ , !grepl("FATGRID", names(df))]
df <- df[ , !grepl("TIREDGRID", names(df))]
df <- df[ , !grepl("COVNEWILT", names(df))]

# remove predictors with too many missing values
df <- df[, !(names(df) %in% "ID")]
df <- df[, !(names(df) %in% "RELSAT")]
df <- df[, !(names(df) %in% "GROWB2_post")]
df <- df[, !(names(df) %in% "CW3_GROWB2")]
df <- df[, !(names(df) %in% "FINAL_WGHT")]
df <- df[, !(names(df) %in% "HSLEEPPP_pre")]
df <- df[, !(names(df) %in% "HSLEEPSP_post")]
df <- df[, !(names(df) %in% "WRKHOURSB_pre")]
df <- df[, !(names(df) %in% "WRKHOURSD_post")]

# remove predictors related to COVID symptoms
df <- df[, !(names(df) %in% "CW3_COVID19")]
df <- df[, !(names(df) %in% "CW3_COVID19POS")]
df <- df[, !(names(df) %in% "CW3_MEMORY")]
df <- df[, !(names(df) %in% "CW3_SKIN")]
df <- df[, !(names(df) %in% "CW3_SHORTB")]
df <- df[, !(names(df) %in% "CW3_PALP")]
df <- df[, !(names(df) %in% "CW3_ACTIVITY")]

colSums(is.na(df))
```

## Check unique values in each column
```{r}
lapply(df, unique)
```

## Replace or turn missing values into a factor
```{r}
# set missing values for number of cigarettes as 0
df$NUMCIGSPP_pre[is.na(df$NUMCIGSPP_pre)] <- 0
df$NUMCIGSSP_post[is.na(df$NUMCIGSSP_post)] <- 0

# convert variables into factor
df$CW3_COHORT <- factor(df$CW3_COHORT)
df$PSEX <- factor(df$PSEX)
df$CW3_COVID_HOSPAD <- factor(df$CW3_COVID_HOSPAD)
df$longcov <- factor(df$longcov)

# convert NA to a missing level
vars_to_convert <- c("CW3_COVNEWILL", "CW3_BEENVAC", "GHQ", "PMED", "CW3_ECONACTIVITYB2", "GHQPRECOVID_pre", "LLI_17_pre", "OUTDOORS_4_pre", "FINANCIALMANB_pre", "ECONACTIVITYB_pre", "SMOKING_pre", "VAPE_pre", "ALDRPP_pre", "FINANCIALMAND_post", "ECONACTIVITYD_post", "VAPESP_post", "ALDRSP_post", "SATN_post", "MHNOW_post")

for (var in vars_to_convert) {
  df[[var]] <- factor(df[[var]], exclude = NULL)
  levels(df[[var]])[is.na(levels(df[[var]]))] <- "Missing"
}

# check unique values
lapply(df, unique)
```

## Remove remaining missing values
```{r}
df_complete <- df[complete.cases(df), ]

dim(df_complete)
colSums(is.na(df_complete))
```

## Split data into training and test set
```{r}
set.seed(38036)
train_idx <- sample(seq_len(nrow(df_complete)), size = 0.7 * nrow(df_complete))
train_data <- df_complete[train_idx, ]
test_data <- df_complete[-train_idx, ]
```

# Logistic regression

## Model
```{r}
log_mod <- glm(longcov ~ . , data = train_data, family = binomial)

summary(log_mod)
```

## Calculate train and test accuracy:
```{r}
# align factor variables for train and test data
factor_vars <- names(train_data)[sapply(train_data, is.factor)]

for (var in factor_vars) {
  train_data[[var]] <- factor(as.character(train_data[[var]]))
  test_data[[var]] <- factor(as.character(test_data[[var]]), levels = levels(train_data[[var]]))
}

# remove missing values in the test data
test_data_clean <- test_data[complete.cases(test_data[,]), ]

# calculate train and test probabilities
train_probs <- predict(log_mod, type = "response")
test_probs <- predict(log_mod, newdata = test_data_clean, type = "response")

train_pred <- ifelse(train_probs > 0.5, 1, 0)
test_pred <- ifelse(test_probs > 0.5, 1, 0)

train_accuracy <- mean(train_pred == train_data$longcov)
test_accuracy <- mean(test_pred == test_data_clean$longcov)

cat("Logistic regression training accuracy:", round(train_accuracy, 3), "\n")
cat("Logistic regression test accuracy:", round(test_accuracy, 3), "\n")
```

## Check confusion matrix
```{r}
cm <- table(Predicted = test_pred, Actual = test_data_clean$longcov)
cm_df <- as.data.frame(cm)

ggplot(cm_df, aes(x = Actual, y = Predicted, fill = Freq)) +
  geom_tile(color = "white") +
  geom_text(aes(label = Freq), vjust = 0.5, size = 5) +
  scale_fill_gradient(low = "grey90", high = "steelblue") +
  labs(
    title = "Confusion Matrix for Logistic Regression",
    x = "Actual",
    y = "Predicted",
    fill = "Count"
  ) +
  theme_minimal()
```
