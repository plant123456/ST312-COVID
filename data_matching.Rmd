---
title: "Data matching"
output: html_document
date: "2025-04-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries
```{r}
library(dplyr)
library(tidyr)
```

# Load data
```{r}
wave3 <- read.csv("covid-19_wave3_survey_cls.csv")
wave1 <- read.csv("covid-19_wave1_survey_cls.csv")
wave2 <- read.csv("covid-19_wave2_survey_cls.csv")

head(wave1)
head(wave2)
head(wave3)
```

#Filter for covid people
```{r}
wave3_cov <- wave3 %>% filter(CW3_COVID19 %in% c(1, 2))

head(wave3_cov)
```

#Variables to keep 
```{r}
id_cols <- c("ID")


w1_vars <- c(
  id_cols,
  "CW1_PNUM00", "CW1_CNUM00", 
  "CW1_PSEX", 
  "CW1_COVIDSYMPT_1", "CW1_COVIDSYMPT_2", "CW1_COVIDSYMPT_3", 
  "CW1_COVIDSYMPT_4", "CW1_COVIDSYMPT_5", "CW1_COVIDSYMPT_6", 
  "CW1_COVIDSYMPT_7", "CW1_COVIDSYMPT_8", "CW1_COVIDSYMPT_18", 
  "CW1_COVIDSYMPT_10", "CW1_COVIDSYMPT_11", "CW1_COVIDSYMPT_12", 
  "CW1_COVIDSYMPT_16", "CW1_COVIDSYMPT_13", "CW1_COVIDSYMPT_14", 
  "CW1_COVIDSYMPT_17", "CW1_COVIDSYMPT_19", "CW1_COVIDSYMPT_20", 
  "CW1_COVIDSYMPT_23", "CW1_GHQ", "CW1_GHQPRECOVID", "CW1_LLI_17", 
  "CW1_HHNUM", "CW1_RELSAT", "CW1_NUMROOMS", "CW1_OUTDOORS_4", 
  "CW1_FINANCIALMANB", "CW1_FINANCIALMAND", "CW1_ECONACTIVITYB", 
  "CW1_WRKHOURSB", "CW1_ECONACTIVITYD", "CW1_WRKHOURSD", 
  "CW1_SMOKING", "CW1_NUMCIGSPP", "CW1_NUMCIGSSP", "CW1_VAPE", 
  "CW1_VAPESP", "CW1_ALDRPP", "CW1_ALDRSP", "CW1_EXCISEPP", 
  "CW1_EXCISESP", "CW1_FRTVEGPP", "CW1_FRTVEGSP", "CW1_HSLEEPPP", 
  "CW1_HSLEEPSP", "CW1_WGHTKG", "CW1_SATN", "CW1_WGHTSTP_4", "CW1_WGHTSTP_5"
)

w2_vars <- c(
  id_cols,
  "CW2_PNUM00", "CW2_CNUM00",
  "CW2_PSEX", "CW2_W1OUTCOME", "CW2_OUTCOME",
  "CW2_COVIDSYMPT_1", "CW2_COVIDSYMPT_2", "CW2_COVIDSYMPT_3", 
  "CW2_COVIDSYMPT_4", "CW2_COVIDSYMPT_5", "CW2_COVIDSYMPT_6", 
  "CW2_COVIDSYMPT_7", "CW2_COVIDSYMPT_8", "CW2_COVIDSYMPT_18", 
  "CW2_COVIDSYMPT_10", "CW2_COVIDSYMPT_11", "CW2_COVIDSYMPT_12", 
  "CW2_COVIDSYMPT_16", "CW2_COVIDSYMPT_13", "CW2_COVIDSYMPT_14", 
  "CW2_COVIDSYMPT_17", "CW2_COVIDSYMPT_19", "CW2_COVIDSYMPT_20", 
  "CW2_COVIDSYMPT_23", "CW2_GHQ", "CW2_GHQPRECOVID", "CW2_LLI_17", 
  "CW2_PMED", "CW2_HHNUM", "CW2_RELSAT", "CW2_NUMROOMS", 
  "CW2_OUTDOORS_4", "CW2_FINANCIALMANB", "CW2_FINANCIALMAND", 
  "CW2_ECONACTIVITYB", "CW2_WRKHOURSB", "CW2_ECONACTIVITYD", 
  "CW2_WRKHOURSD", "CW2_SMOKING", "CW2_NUMCIGSPP", "CW2_NUMCIGSSP", 
  "CW2_VAPE", "CW2_VAPESP", "CW2_ALDRPP", "CW2_ALDRSP", 
  "CW2_EXCISEPP", "CW2_EXCISESP", "CW2_FRTVEGPP", "CW2_FRTVEGSP", 
  "CW2_HSLEEPPP", "CW2_HSLEEPSP", "CW2_WGHTKG", 
  "CW2_SATN", "CW2_MHNOW", "CW2_WGHTSTP_4", "CW2_WGHTSTP_5"
)

w3_vars <- c(
  id_cols,
  "CW3_PNUM00", "CW3_CNUM00", "CW3_COHORT",
  "CW3_PSEX", "CW3_W1OUTCOME", "CW3_OUTCOME", "CW3_W2OUTCOME", 
  "CW3_COVID19", "CW3_COVID19POS", "CW3_COVID_HOSPAD", 
  "CW3_COVFUNC", "CW3_COVNEWILL", "CW3_COVNEWILT_1", "CW3_COVNEWILT_2", 
  "CW3_COVNEWILT_3", "CW3_COVNEWILT_4", "CW3_COVNEWILT_5", 
  "CW3_COVNEWILT_6", "CW3_COVNEWILT_7", "CW3_COVNEWILT_8", 
  "CW3_TIREDGRID_1", "CW3_TIREDGRID_2", "CW3_TIREDGRID_3", 
  "CW3_TIREDGRID_4", "CW3_TIREDGRID_5", "CW3_TIREDGRID_6", 
  "CW3_FATGRID_1", "CW3_FATGRID_2", "CW3_FATGRID_3", "CW3_FATGRID_4", 
  "CW3_FATGRID_5", "CW3_FATGRID_6", "CW3_FATGRID_7", "CW3_FATGRID_8", 
  "CW3_FATGRID_9", "CW3_FATGRID_10", "CW3_MEMORY", "CW3_SKIN", 
  "CW3_SHORTB", "CW3_PALP", "CW3_ACTIVITY", 
  "CW3_COVIDSYMPT_1", "CW3_COVIDSYMPT_2", "CW3_COVIDSYMPT_3", 
  "CW3_COVIDSYMPT_4", "CW3_COVIDSYMPT_5", "CW3_COVIDSYMPT_6", 
  "CW3_COVIDSYMPT_7", "CW3_COVIDSYMPT_8", "CW3_COVIDSYMPT_18", 
  "CW3_COVIDSYMPT_10", "CW3_COVIDSYMPT_11", "CW3_COVIDSYMPT_12", 
  "CW3_COVIDSYMPT_16", "CW3_COVIDSYMPT_13", "CW3_COVIDSYMPT_14", 
  "CW3_COVIDSYMPT_17", "CW3_COVIDSYMPT_19", "CW3_COVIDSYMPT_20", 
  "CW3_COVIDSYMPT_23", "CW3_BEENVAC", "CW3_GHQ", "CW3_GHQPRECOVID", 
  "CW3_LLI_17", "CW3_PMED", "CW3_HHNUM", "CW3_RELSAT", "CW3_NUMROOMS", 
  "CW3_OUTDOORS_4", "CW3_FINANCIALMANB", "CW3_FINANCIALMAND", 
  "CW3_ECONACTIVITYB2", "CW3_WRKHOURSB", "CW3_GROWB2", 
  "CW3_ECONACTIVITYD", "CW3_WRKHOURSD", "CW3_SMOKING", "CW3_NUMCIGSSP", 
  "CW3_VAPE", "CW3_VAPESP", "CW3_ALDRSP", "CW3_EXCISESP", 
  "CW3_FRTVEGSP", "CW3_HSLEEPSP", 
  "CW3_SATN", "CW3_MHNOW"
)
```

##RUN BOTH OF THE DATA VISUALISATION SECTIONS AD A NEW LONGCOV VARIABLE IS MADE HERE 
#Filtering all three datasets to only keep the selected columns 
```{r}

# Filter Wave 1
wave1_filtered <- wave1 %>%
  select(any_of(w1_vars))  # any_of() ensures no error if a variable is missing

# Filter Wave 2
wave2_filtered <- wave2 %>%
  select(any_of(w2_vars))

# Filter Wave 3
wave3_filtered <- wave3_cov %>%
  select(any_of(w3_vars))
```

#Seeing how many participants in wave 3 participated in previous waves 
```{r}
library(ggplot2)

# Create mutually exclusive participation groups
wave3_filtered_plot <- wave3_filtered %>%
  mutate(
    participation = case_when(
      CW3_W1OUTCOME == 1 & CW3_W2OUTCOME == 1 ~ "Both Waves 1 & 2",
      CW3_W1OUTCOME == 1 & CW3_W2OUTCOME != 1 ~ "Only Wave 1",
      CW3_W1OUTCOME != 1 & CW3_W2OUTCOME == 1 ~ "Only Wave 2",
      TRUE ~ "Only Wave 3"  # Default (neither W1 nor W2)
    )
  )

# Summarize counts
participation_summary <- wave3_filtered_plot %>%
  count(participation)

# Plot
ggplot(participation_summary, aes(x = participation, y = n, fill = participation)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), vjust = -0.5, size = 4) +
  labs(
    title = "Participation in Previous Waves (All Wave 3 Respondents)",
    x = "Participation Group",
    y = "Number of Respondents"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

#Creating subset dataframe with only long covid people 
```{r}
wave3_lc <- wave3_filtered %>%
  mutate(
    longcov = ifelse(CW3_COVFUNC %in% c(6, 7), 1, 0)
  )



wave3_longcovid <- wave3_lc %>%
  filter(longcov == 1) %>%
  mutate(
    participation = case_when(
      CW3_W1OUTCOME == 1 & CW3_W2OUTCOME == 1 ~ "Both Waves 1 & 2",
      CW3_W1OUTCOME == 1 & CW3_W2OUTCOME != 1 ~ "Only Wave 1",
      CW3_W1OUTCOME != 1 & CW3_W2OUTCOME == 1 ~ "Only Wave 2",
      TRUE ~ "Only Wave 3"
    )
  )

# Summarize counts for Long COVID group
participation_summary_long <- wave3_longcovid %>%
  count(participation)

# Plot
ggplot(participation_summary_long, aes(x = participation, y = n, fill = participation)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), vjust = -0.5, size = 4) +
  labs(
    title = "Participation in Previous Waves (Long COVID Cases in Wave 3)",
    x = "Participation Group",
    y = "Number of Respondents"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

#Changing weight from stones and pounds to KG for waves 1 & 2
```{r}
# convert stones and pounds to kg
wave1_wght_add <- wave1_filtered %>%
  mutate(CW1_WGHT = round((CW1_WGHTSTP_4 * 6.35029) + (CW1_WGHTSTP_5 * 0.453592)))

# combine column for weight in kg and weight in stoens and pounds
wave1_wght_tgh <- wave1_wght_add %>%
  mutate(CW1_FINAL_WGHT = coalesce(CW1_WGHT, CW1_WGHTKG))

wave1_wght_final <- wave1_wght_tgh %>%
  select(-c(CW1_WGHT, CW1_WGHTKG, CW1_WGHTSTP_4, CW1_WGHTSTP_5))
```

```{r}
# convert stones and pounds to kg
wave2_wght_add <- wave2_filtered %>%
  mutate(CW2_WGHT = round((CW2_WGHTSTP_4 * 6.35029) + (CW2_WGHTSTP_5 * 0.453592)))

# combine column for weight in kg and weight in stoens and pounds
wave2_wght_tgh <- wave2_wght_add %>%
  mutate(CW2_FINAL_WGHT = coalesce(CW2_WGHT, CW2_WGHTKG))

wave2_wght_final <- wave2_wght_tgh %>%
  select(-c(CW2_WGHT, CW2_WGHTKG, CW2_WGHTSTP_4, CW2_WGHTSTP_5))
```

#Checking how many missing weight values there are
```{r}
head(wave1_wght_final)
head(wave2_wght_final)
```


#FOR MS IDs creating unqiue IDs for every family member
```{r}

wave1_clean <- wave1_wght_final
wave2_clean <- wave2_wght_final
wave3_clean <- wave3_lc

head(wave1_clean)
head(wave2_clean)
head(wave3_clean)
```

#For MS IDs also making unique IDs for family members using CNUM 
```{r}
make_unique_ids <- function(data) {
  # Find columns (case-insensitive)
  id_col <- grep("^ID$", names(data), value = TRUE, ignore.case = TRUE)[1]
  pnum_col <- grep("PNUM", names(data), value = TRUE, ignore.case = TRUE)[1]
  cnum_col <- grep("CNUM", names(data), value = TRUE, ignore.case = TRUE)[1]
  
  # Known duplicate IDs (add more as needed)
  duplicate_ids <- c("M20385Y", "M29249D", "M29318Z", "M33080B")
  
  if (!is.na(id_col)) {
    data <- data %>%
      mutate(
        # First pass: Add PNUM if exists and > 0
        !!id_col := if (!is.na(pnum_col)) {
          ifelse(!is.na(.data[[pnum_col]]) & .data[[pnum_col]] > 0,
                 paste0(.data[[id_col]], "_P", .data[[pnum_col]]),
                 .data[[id_col]])
        } else .data[[id_col]],
        
        # Second pass: Force CNUM for known duplicates
        !!id_col := if (!is.na(cnum_col)) {
          case_when(
            # Case 1: Known duplicates get CNUM appended unconditionally
            .data[[id_col]] %in% duplicate_ids ~ 
              paste0(.data[[id_col]], "_C", .data[[cnum_col]]),
            
            # Case 2: Regular duplicates get CNUM only if PNUM was NA/0
            duplicated(.data[[id_col]]) | duplicated(.data[[id_col]], fromLast = TRUE) ~
              ifelse(is.na(.data[[pnum_col]]) | .data[[pnum_col]] == 0,
                     paste0(.data[[id_col]], "_C", .data[[cnum_col]]),
                     .data[[id_col]]),
            
            # Default: Keep existing ID
            TRUE ~ .data[[id_col]]
          )
        } else .data[[id_col]]
      )
  }
  return(data)
}

wave1_unq <- make_unique_ids(wave1_clean)
wave2_unq <- make_unique_ids(wave2_clean)
wave3_unq <- make_unique_ids(wave3_clean)

# Check for duplicates
cat("Wave 1 duplicates:", sum(duplicated(wave1_unq$ID)), "\n")
cat("Wave 2 duplicates:", sum(duplicated(wave2_unq$ID)), "\n")
cat("Wave 3 duplicates:", sum(duplicated(wave3_unq$ID)), "\n")

# Example output:
# ID = "MCS123" (if PNUM = 0)
# ID = "MCS123_1" (if PNUM = 1)

```

#Checking for duplicate IDs
```{r}
wave1_unq %>% 
  count(ID) %>% 
  filter(n > 1)

# Check Wave 2 for duplicate IDs
wave2_unq %>% 
  count(ID) %>% 
  filter(n > 1)

# Check Wave 3 for duplicate IDs (should be none if it's your primary dataset)
wave3_unq %>% 
  count(ID) %>% 
  filter(n > 1)
```


#Merging columns from waves 1 and 2 for participants who answered the wave 3 survey 
```{r}
# Left-join Wave 1 and Wave 2 data to Wave 3
merged_data <- wave3_unq %>%
  left_join(wave1_unq, by = "ID") %>%
  left_join(wave2_unq, by = "ID")

head(merged_data)
```

#Filtering out wave 3 new participants
```{r}
wave3_not_new <- merged_data %>%
  filter(CW3_W1OUTCOME == 1 | CW3_W2OUTCOME == 1)

summary(wave3_not_new)
head(wave3_not_new)
```
#Summing the counts of the different responses to CW3_outcome - whether they participated in W3 or not 
```{r}
# Count occurrences of each CW3_OUTCOME category
cw3_outcome_summary <- wave3_not_new %>%
  count(CW3_OUTCOME)

# View the summary
print(cw3_outcome_summary)
```
#Filtering out those that responded 2 for CW3_outcome as the definition of this is not clear from the user guide
```{r}
wave3_outcome1 <- wave3_not_new %>%
  filter(CW3_OUTCOME == 1)
```

#Plots for final filtered and merged dataset 
```{r}
# Create mutually exclusive participation groups
wave3_filtered_plot2 <- wave3_outcome1 %>%
  mutate(
    participation = case_when(
      CW3_W1OUTCOME == 1 & CW3_W2OUTCOME == 1 ~ "Both Waves 1 & 2",
      CW3_W1OUTCOME == 1 & CW3_W2OUTCOME != 1 ~ "Only Wave 1",
      CW3_W1OUTCOME != 1 & CW3_W2OUTCOME == 1 ~ "Only Wave 2",
      TRUE ~ "Only Wave 3"  # Default (neither W1 nor W2)
    )
  )

# Summarize counts
participation_summary1 <- wave3_filtered_plot2 %>%
  count(participation)

# Plot
ggplot(participation_summary1, aes(x = participation, y = n, fill = participation)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), vjust = -0.5, size = 4) +
  labs(
    title = "Participation in Previous Waves (All Wave 3 Respondents)",
    x = "Participation Group",
    y = "Number of Respondents"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
wave3_longcov <- wave3_outcome1 %>%
  mutate(
    longcov = ifelse(CW3_COVFUNC %in% c(6, 7), 1, 0)
  )



wave3_longcovidcount <- wave3_longcov %>%
  filter(longcov == 1) %>%
  mutate(
    participation = case_when(
      CW3_W1OUTCOME == 1 & CW3_W2OUTCOME == 1 ~ "Both Waves 1 & 2",
      CW3_W1OUTCOME == 1 & CW3_W2OUTCOME != 1 ~ "Only Wave 1",
      CW3_W1OUTCOME != 1 & CW3_W2OUTCOME == 1 ~ "Only Wave 2",
      TRUE ~ "Only Wave 3"
    )
  )

# Summarize counts for Long COVID group
participation_summary_longcov <- wave3_longcovidcount %>%
  count(participation)

# Plot
ggplot(participation_summary_longcov, aes(x = participation, y = n, fill = participation)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), vjust = -0.5, size = 4) +
  labs(
    title = "Participation in Previous Waves (Long COVID Cases in Wave 3)",
    x = "Participation Group",
    y = "Number of Respondents"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

#Going from the filtered and merged dataframe containing longcov - wave3_long cov to adding an age variable and generalising the variables from 3 waves into single variables 

#Pre pandemic outbreak variables 
```{r}
#Take first wave replied value and make general value and then get rid of old ones

# First, define participation groups using ONLY the specified flags
merged_data_participate <- wave3_longcov %>%
  mutate(
    participation_group = case_when(
      # Case 1: Only Wave 1 + Wave 3 (participated in W1 but not W2)
      CW3_W1OUTCOME == 1 & CW3_W2OUTCOME != 1 ~ "W1_W3",
      
      # Case 2: Only Wave 2 + Wave 3 (participated in W2 but not W1)
      CW3_W1OUTCOME != 1 & CW3_W2OUTCOME == 1 ~ "W2_W3",
      
      # Case 3: All three waves (participated in both W1 and W2)
      CW3_W1OUTCOME == 1 & CW3_W2OUTCOME == 1 ~ "W1_W2_W3",
      
      TRUE ~ NA_character_
    )
  )
```

```{r}
head(merged_data_participate)
```

```{r}

# Create consolidated variables with _pre suffix (except FINAL_WGHT and NUMROOMS)
merged_data_precov <- merged_data_participate %>%
  mutate(
    # Variables that get _pre suffix
    GHQPRECOVID_pre = case_when(
      participation_group == "W1_W3" ~ CW1_GHQPRECOVID,
      participation_group == "W2_W3" ~ CW2_GHQPRECOVID,
      participation_group == "W1_W2_W3" ~ CW1_GHQPRECOVID
    ),
    LLI_17_pre = case_when(
      participation_group == "W1_W3" ~ CW1_LLI_17,
      participation_group == "W2_W3" ~ CW2_LLI_17,
      participation_group == "W1_W2_W3" ~ CW1_LLI_17
    ),
    OUTDOORS_4_pre = case_when(
      participation_group == "W1_W3" ~ CW1_OUTDOORS_4,
      participation_group == "W2_W3" ~ CW2_OUTDOORS_4,
      participation_group == "W1_W2_W3" ~ CW1_OUTDOORS_4
    ),
    FINANCIALMANB_pre = case_when(
      participation_group == "W1_W3" ~ CW1_FINANCIALMANB,
      participation_group == "W2_W3" ~ CW2_FINANCIALMANB,
      participation_group == "W1_W2_W3" ~ CW1_FINANCIALMANB
    ),
    ECONACTIVITYB_pre = case_when(
      participation_group == "W1_W3" ~ CW1_ECONACTIVITYB,
      participation_group == "W2_W3" ~ CW2_ECONACTIVITYB,
      participation_group == "W1_W2_W3" ~ CW1_ECONACTIVITYB
    ),
    WRKHOURSB_pre = case_when(
      participation_group == "W1_W3" ~ CW1_WRKHOURSB,
      participation_group == "W2_W3" ~ CW2_WRKHOURSB,
      participation_group == "W1_W2_W3" ~ CW1_WRKHOURSB
    ),
    
    # Variables that don't get _pre suffix
    FINAL_WGHT = case_when(
      participation_group == "W1_W3" ~ CW1_FINAL_WGHT,
      participation_group == "W2_W3" ~ CW2_FINAL_WGHT,
      participation_group == "W1_W2_W3" ~ CW1_FINAL_WGHT
    ),
    NUMROOMS = case_when(
      participation_group == "W1_W3" ~ CW1_NUMROOMS,
      participation_group == "W2_W3" ~ CW2_NUMROOMS,
      participation_group == "W1_W2_W3" ~ CW1_NUMROOMS
    ),
    
    # Behavioral variables (get _pre suffix)
    SMOKING_pre = case_when(
      participation_group == "W1_W3" ~ CW1_SMOKING,
      participation_group == "W2_W3" ~ CW2_SMOKING,
      participation_group == "W1_W2_W3" ~ CW1_SMOKING
    ),
    NUMCIGSPP_pre = case_when(
      participation_group == "W1_W3" ~ CW1_NUMCIGSPP,
      participation_group == "W2_W3" ~ CW2_NUMCIGSPP,
      participation_group == "W1_W2_W3" ~ CW1_NUMCIGSPP
    ),
    VAPE_pre = case_when(
      participation_group == "W1_W3" ~ CW1_VAPE,
      participation_group == "W2_W3" ~ CW2_VAPE,
      participation_group == "W1_W2_W3" ~ CW1_VAPE
    ),
    ALDRPP_pre = case_when(
      participation_group == "W1_W3" ~ CW1_ALDRPP,
      participation_group == "W2_W3" ~ CW2_ALDRPP,
      participation_group == "W1_W2_W3" ~ CW1_ALDRPP
    ),
    EXCISEPP_pre = case_when(
      participation_group == "W1_W3" ~ CW1_EXCISEPP,
      participation_group == "W2_W3" ~ CW2_EXCISEPP,
      participation_group == "W1_W2_W3" ~ CW1_EXCISEPP
    ),
    FRTVEGPP_pre = case_when(
      participation_group == "W1_W3" ~ CW1_FRTVEGPP,
      participation_group == "W2_W3" ~ CW2_FRTVEGPP,
      participation_group == "W1_W2_W3" ~ CW1_FRTVEGPP
    ),
    HSLEEPPP_pre = case_when(
      participation_group == "W1_W3" ~ CW1_HSLEEPPP,
      participation_group == "W2_W3" ~ CW2_HSLEEPPP,
      participation_group == "W1_W2_W3" ~ CW1_HSLEEPPP
    )
  )

# Remove old wave-specific columns (optional)
merged_data_precov2 <- merged_data_precov %>%
  select(-matches("^CW[1-3]_((GHQPRECOVID$|LLI_17$|OUTDOORS_4$|FINANCIALMANB$|ECONACTIVITYB$|WRKHOURSB$|NUMROOMS$|FINAL_WGHT$|SMOKING$|NUMCIGSPP$|VAPE$|ALDRPP$|EXCISEPP$|FRTVEGPP$|HSLEEPPP$))"))

```

#Demographic variables/ Set variables 
```{r}
#Drop w1 and w2 for these variables 
merged_data_demo <- merged_data_precov2 %>%
  rename(
    # Demographic variables
    PSEX = CW3_PSEX,
    GHQ = CW3_GHQ,
    HHNUM = CW3_HHNUM,
    RELSAT = CW3_RELSAT,
    
    # Special case - PMED only exists in Wave 2
    PMED = CW3_PMED
  )

# Step 2: Remove all wave-specific versions of these variables
merged_data_demographic <- merged_data_demo %>%
  select(
    -matches("^CW[1-3]_(PSEX$|GHQ$|HHNUM$|RELSAT$)"),  # Removes all wave versions
    -CW2_PMED  # Only keep CW2_PMED (already renamed to PMED)
  )

```

```{r}
head(merged_data_demographic)
```

#Post pandemic outbreak variables
```{r}
#rename with postfix post and drop any of this variable from the previous columns 

merged_data_postcov <- merged_data_demographic %>%
  mutate(
    # Create _post versions of all specified Wave 3 variables
    FINANCIALMAND_post = CW3_FINANCIALMAND,
    GROWB2_post = CW3_GROWB2,
    ECONACTIVITYD_post = CW3_ECONACTIVITYD,
    WRKHOURSD_post = CW3_WRKHOURSD,
    NUMCIGSSP_post = CW3_NUMCIGSSP,
    VAPESP_post = CW3_VAPESP,
    ALDRSP_post = CW3_ALDRSP,
    EXCISESP_post = CW3_EXCISESP,
    FRTVEGSP_post = CW3_FRTVEGSP,
    HSLEEPSP_post = CW3_HSLEEPSP,
    SATN_post = CW3_SATN,
    MHNOW_post = CW3_MHNOW
  ) %>%
  # Remove all wave-specific versions (W1, W2, and W3)
  select(
    -CW1_FINANCIALMAND, -CW2_FINANCIALMAND, -CW3_FINANCIALMAND,
    -CW1_ECONACTIVITYD, -CW2_ECONACTIVITYD, -CW3_ECONACTIVITYD,
    -CW1_WRKHOURSD, -CW2_WRKHOURSD, -CW3_WRKHOURSD,
    -CW1_NUMCIGSSP, -CW2_NUMCIGSSP, -CW3_NUMCIGSSP,
    -CW1_VAPESP, -CW2_VAPESP, -CW3_VAPESP,
    -CW1_ALDRSP, -CW2_ALDRSP, -CW3_ALDRSP,
    -CW1_EXCISESP, -CW2_EXCISESP, -CW3_EXCISESP,
    -CW1_FRTVEGSP, -CW2_FRTVEGSP, -CW3_FRTVEGSP,
    -CW1_HSLEEPSP, -CW2_HSLEEPSP, -CW3_HSLEEPSP,
    -CW1_SATN, -CW2_SATN, -CW3_SATN,
    -CW2_MHNOW, -CW3_MHNOW
  )

```

```{r}
head(merged_data_postcov)
```

#Covid symptoms
```{r}
#Take whether any of the variable have appeared or not to make binary variable 
# Start with the original data
merged_data_covsympt <- merged_data_postcov
# List of symptom numbers (without prefix)

symptom_nums <- c(1,2,3,4,5,6,7,8,18,10,11,12,16,13,14,17,19,20,23)

# Loop to add one general binary column per symptom
for (num in symptom_nums) {
  wave_vars <- paste0("CW", 1:3, "_COVIDSYMPT_", num)
  
  merged_data_covsympt <- merged_data_covsympt %>%
    mutate(!!paste0("COVIDSYMPT_", num) := if_else(
      rowSums(across(all_of(wave_vars), ~ .x == 1), na.rm = TRUE) > 0,
      1, 0
    ))
}

# Now remove the original wave-specific columns
merged_data_covsympt1 <- merged_data_covsympt %>%
  select(-matches("^CW[1-3]_COVIDSYMPT_"))

```

```{r}
head(merged_data_covsympt)
head(merged_data_covsympt1)
```

```{r}
#Drop outcome "CW3_W1OUTCOME", "CW3_OUTCOME", "CW3_W2OUTCOME", variables and CW3_PNUM00 CW3_CNUM00 CW1_PNUM00 CW1_CNUM00 and covfunc

cols_to_drop <- c("CW3_W1OUTCOME", "CW3_OUTCOME", "CW3_W2OUTCOME",
                  "CW3_PNUM00", "CW3_CNUM00", "CW1_PNUM00", "CW1_CNUM00", "CW3_COVFUNC", "CW2_PNUM00", "CW2_CNUM00", "CW2_W1OUTCOME"      , "CW2_OUTCOME",  "participation_group")

merged_data_allcol <- merged_data_covsympt1 %>%
  select(-any_of(cols_to_drop))

```

#Set all negative ones as N/A check first if any negatives exist
```{r}
neg_col_check <- sapply(merged_data_covsympt1, function(x) any(x < 0, na.rm = TRUE))
neg_col_check[neg_col_check == TRUE]
```

#Export merged data filtered for non-only-wave 3 participants
```{r}
# 1. Save wave1_clean
#write.xlsx(merged_data, file = "merged_wave_data_w1&2participants.xlsx")
```


#Exporting the merged dataset 
```{r}
library(openxlsx)  # Install with install.packages("openxlsx") if needed

# 1. Save wave1_clean
#write.xlsx(merged_data, file = "merged_wave_data.xlsx")
```

#Export final merged & generalised dataset
```{r}
library(openxlsx)
write.xlsx(merged_data_allcol, file = "final_merged_generalised_dataset.xlsx")
```
