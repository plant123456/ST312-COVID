---
title: "Latent Class Analysis"
---

# Load library
```{r}
library(poLCA)
library(dplyr)
library(openxlsx)
```

# Load data
```{r}
df <- read.xlsx("final_merged_generalised_dataset.xlsx")

head(df)
```

# Analysis of individuals with long covid 

## Filter data
```{r}
filtered_df <- subset(df, longcov == 1)

dim(filtered_df)
```

## Check the number of null values
```{r}
colSums(is.na(filtered_df))
```

## Select variables
```{r}
selected_df <- filtered_df[, intersect(c(
  "PSEX", "CW3_COVID19", "CW3_COVID_HOSPAD", "CW3_COVNEWILL", 
  "CW3_FATGRID_1", "CW3_FATGRID_2", "CW3_FATGRID_3", "CW3_FATGRID_4", 
  "CW3_FATGRID_5", "CW3_FATGRID_6", "CW3_FATGRID_7", "CW3_FATGRID_8", 
  "CW3_FATGRID_9", "CW3_FATGRID_10", "CW3_MEMORY", "CW3_SKIN", "CW3_SHORTB", "CW3_PALP", "CW3_ACTIVITY", "COVIDSYMPT_1", "COVIDSYMPT_2", "COVIDSYMPT_3", "COVIDSYMPT_4", "COVIDSYMPT_5", "COVIDSYMPT_6", 
  "COVIDSYMPT_7", "COVIDSYMPT_8", "COVIDSYMPT_18", 
  "COVIDSYMPT_10", "COVIDSYMPT_11", "COVIDSYMPT_12", 
  "COVIDSYMPT_16", "COVIDSYMPT_13", "COVIDSYMPT_14", 
  "COVIDSYMPT_17", "COVIDSYMPT_19", "COVIDSYMPT_20", 
  "COVIDSYMPT_23", "GHQPRECOVID_pre", "LLI_17_pre", "OUTDOORS_4_pre", "FINANCIALMANB_pre", "SMOKING_pre", "VAPE_pre", "ALDRPP_pre", "FINANCIALMAND_post", "ALDRSP_post", "MHNOW_post", "PMED"), colnames(filtered_df))]

head(selected_df)
dim(selected_df)
```

## Check column values
```{r}
# Check the unique values in each column
unique_values <- sapply(selected_df, unique)
print(unique_values)
```

## Convert variables to factors
```{r}
# For sex
selected_df$PSEX <- factor(selected_df$PSEX, levels = c(1, 2), labels = c("Male", "Female"))

# For memory
selected_df$CW3_MEMORY <- factor(selected_df$CW3_MEMORY, levels = c(1, 2, 3, 4), labels = c("Better", "Usual", "Worse", "Much Worse"))

# For GHQ (General Health Questionnaire)
selected_df$GHQPRECOVID_pre <- factor(selected_df$GHQPRECOVID_pre, levels = c(1, 2, 3, 4, 5), labels = c("Excellent", "Very Good", "Good", "Fair", "Poor"))

# For FINANCIALMANB
selected_df$FINANCIALMANB_pre <- factor(selected_df$FINANCIALMANB_pre, levels = c(1, 2, 3, 4, 5), labels = c("Comfortable", "Satisfactory", "Managing", "Difficult", "Very Difficult"))

# For FINANCIALMAND
selected_df$FINANCIALMAND_post <- factor(selected_df$FINANCIALMAND_post, levels = c(1, 2, 3, 4, 5), labels = c("Much Worse", "Worse", "Same", "Better", "Much Better"))

# For smoking
selected_df$SMOKING_pre <- factor(selected_df$SMOKING_pre, levels = c(1, 2, 3, 4), labels = c("Never", "Formerly", "Occasionally", "Daily"))

# For vape
selected_df$VAPE_pre <- factor(selected_df$VAPE_pre, levels = c(1, 2, 3, 4), labels = c("Never", "Formerly", "Occasionally", "Daily"))

# For alcohol
selected_df$ALDRSP_post <- factor(selected_df$ALDRSP_post, levels = c(1, 2, 3, 4, 5), labels = c("Very Frequently", "Frequently", "Weekly", "Infrequently", "Never"))

# For mental health
selected_df$MHNOW_post <- factor(selected_df$MHNOW_post, levels = c(1, 2, 3, 4, 5), labels = c("Excellent", "Very Good", "Good", "Fair", "Poor"))

# Function to convert all 0/1 columns into "No"/"Yes"
convert_to_yes_no <- function(df) {
  for (col in colnames(df)) {
    # If the column contains only 0, 1 convert it to "Yes"/"No"
    if (all(df[[col]] %in% c(0, 1, NA))) {
      df[[col]] <- factor(df[[col]], levels = c(0, 1), labels = c("No", "Yes"))
    }
  }
  return(df)
}

selected_df <- convert_to_yes_no(selected_df)

# Function to convert all 1/2 columns into "Yes"/"No"
convert_to_yes_no2 <- function(df) {
  for (col in colnames(df)) {
    # If the column contains only 1, 2, and NA, convert it to "Yes"/"No"
    if (all(df[[col]] %in% c(1, 2, NA))) {
      df[[col]] <- factor(df[[col]], levels = c(1, 2), labels = c("Yes", "No"))
    }
  }
  return(df)
}

selected_df <- convert_to_yes_no2(selected_df)

# Function to convert 1, 2, 3, 4, and NA into the combined categories
convert_to_combined_categories <- function(df) {
  # Loop through all columns and apply the conversion logic
  for (col in colnames(df)) {
    # Check if the column contains values 1, 2, 3, 4 (and potentially NA)
    if (all(df[[col]] %in% c(1, 2, 3, 4, NA))) {
      # Apply the conversion logic for values 1 to 4
      df[[col]] <- factor(df[[col]], 
                          levels = c(1, 2, 3, 4), 
                          labels = c("Rarely", "Sometimes", "Often", "Almost Always"), exclude = NA)
      
      # Ensure NA values remain as NA
      df[[col]][is.na(df[[col]])] <- NA
    }
  }
  return(df)
}

selected_df <- convert_to_combined_categories(selected_df)

# Function to convert 1, 2, 3, 4, 5 and NA into the combined categories
convert_to_combined_categories2 <- function(df) {
  # Loop through all columns and apply the conversion logic
  for (col in colnames(df)) {
    # Check if the column contains values 1, 2, 3, 4, 5 (and potentially NA)
    if (all(df[[col]] %in% c(1, 2, 3, 4, 5, NA))) {
      # Apply the conversion logic for values 1 to 4
      df[[col]] <- factor(df[[col]], 
                          levels = c(1, 2, 3, 4, 5), 
                          labels = c("Never", "Rarely", "Occasionally", "Frequently", "Daily"), exclude = NA)
      
      # Ensure NA values remain as NA
      df[[col]][is.na(df[[col]])] <- NA
    }
  }
  return(df)
}

selected_df <- convert_to_combined_categories2(selected_df)

head(selected_df)
```

## Check column values
```{r}
# Check the unique values in each column
unique_values <- sapply(selected_df, unique)
print(unique_values)
```
## Check and convert column type
```{r}
selected_df$CW3_FATGRID_1 <- addNA(selected_df$CW3_FATGRID_1, ifany = FALSE)
selected_df$CW3_FATGRID_2 <- addNA(selected_df$CW3_FATGRID_2, ifany = FALSE)
selected_df$CW3_FATGRID_3 <- addNA(selected_df$CW3_FATGRID_3, ifany = FALSE)
selected_df$CW3_FATGRID_4 <- addNA(selected_df$CW3_FATGRID_4, ifany = FALSE)
selected_df$CW3_FATGRID_5 <- addNA(selected_df$CW3_FATGRID_5, ifany = FALSE)
selected_df$CW3_FATGRID_6 <- addNA(selected_df$CW3_FATGRID_6, ifany = FALSE)
selected_df$CW3_FATGRID_7 <- addNA(selected_df$CW3_FATGRID_7, ifany = FALSE)
selected_df$CW3_FATGRID_8 <- addNA(selected_df$CW3_FATGRID_8, ifany = FALSE)
selected_df$CW3_FATGRID_9 <- addNA(selected_df$CW3_FATGRID_9, ifany = FALSE)
selected_df$CW3_FATGRID_10 <- addNA(selected_df$CW3_FATGRID_10, ifany = FALSE)
selected_df$CW3_SKIN <- addNA(selected_df$CW3_SKIN, ifany = FALSE)
selected_df$CW3_SHORTB <- addNA(selected_df$CW3_SHORTB, ifany = FALSE)
selected_df$CW3_PALP <- addNA(selected_df$CW3_PALP, ifany = FALSE)
selected_df$CW3_ACTIVITY <- addNA(selected_df$CW3_ACTIVITY, ifany = FALSE)
selected_df$GHQPRECOVID_pre <- addNA(selected_df$GHQPRECOVID_pre, ifany = FALSE)
selected_df$LLI_17_pre <- addNA(selected_df$LLI_17_pre, ifany = FALSE)
selected_df$OUTDOORS_4_pre <- addNA(selected_df$OUTDOORS_4_pre, ifany = FALSE)
selected_df$FINANCIALMANB_pre <- addNA(selected_df$FINANCIALMANB_pre, ifany = FALSE)
selected_df$SMOKING_pre <- addNA(selected_df$SMOKING_pre, ifany = FALSE)
selected_df$VAPE_pre <- addNA(selected_df$VAPE_pre, ifany = FALSE)
selected_df$ALDRPP_pre <- addNA(selected_df$ALDRPP_pre, ifany = FALSE)
selected_df$ALDRSP_post <- addNA(selected_df$ALDRSP_post, ifany = FALSE)
selected_df$MHNOW_post <- addNA(selected_df$MHNOW_post, ifany = FALSE)

str(selected_df)
```

# LCA model
```{r}
lca_model <- poLCA(cbind(PSEX, CW3_COVID19, CW3_COVID_HOSPAD, CW3_COVNEWILL, 
CW3_FATGRID_1, CW3_FATGRID_2, CW3_FATGRID_3, CW3_FATGRID_4, 
CW3_FATGRID_5, CW3_FATGRID_6, CW3_FATGRID_7, CW3_FATGRID_8, 
CW3_FATGRID_9, CW3_FATGRID_10, CW3_MEMORY, CW3_SKIN, CW3_SHORTB, CW3_PALP, CW3_ACTIVITY, COVIDSYMPT_1, COVIDSYMPT_2, COVIDSYMPT_3, COVIDSYMPT_4, COVIDSYMPT_5, COVIDSYMPT_6, 
COVIDSYMPT_7, COVIDSYMPT_8, COVIDSYMPT_18, 
COVIDSYMPT_10, COVIDSYMPT_11, COVIDSYMPT_12, 
COVIDSYMPT_16, COVIDSYMPT_13, COVIDSYMPT_14, 
COVIDSYMPT_17, COVIDSYMPT_19, COVIDSYMPT_20, 
COVIDSYMPT_23, GHQPRECOVID_pre, LLI_17_pre, OUTDOORS_4_pre, FINANCIALMANB_pre, SMOKING_pre, VAPE_pre, ALDRPP_pre, FINANCIALMAND_post, ALDRSP_post, MHNOW_post, PMED) ~ 1, 
                   data = selected_df, nclass = 3)

summary(lca_model)
```

## Compare AIC and BIC values fo different number of classes
```{r}
model_1_class <- poLCA(cbind(PSEX, CW3_COVID19, CW3_COVID_HOSPAD, CW3_COVNEWILL, 
CW3_FATGRID_1, CW3_FATGRID_2, CW3_FATGRID_3, CW3_FATGRID_4, 
CW3_FATGRID_5, CW3_FATGRID_6, CW3_FATGRID_7, CW3_FATGRID_8, 
CW3_FATGRID_9, CW3_FATGRID_10, CW3_MEMORY, CW3_SKIN, CW3_SHORTB, CW3_PALP, CW3_ACTIVITY, COVIDSYMPT_1, COVIDSYMPT_2, COVIDSYMPT_3, COVIDSYMPT_4, COVIDSYMPT_5, COVIDSYMPT_6, 
COVIDSYMPT_7, COVIDSYMPT_8, COVIDSYMPT_18, 
COVIDSYMPT_10, COVIDSYMPT_11, COVIDSYMPT_12, 
COVIDSYMPT_16, COVIDSYMPT_13, COVIDSYMPT_14, 
COVIDSYMPT_17, COVIDSYMPT_19, COVIDSYMPT_20, 
COVIDSYMPT_23, GHQPRECOVID_pre, LLI_17_pre, OUTDOORS_4_pre, FINANCIALMANB_pre, SMOKING_pre, VAPE_pre, ALDRPP_pre, FINANCIALMAND_post, ALDRSP_post, MHNOW_post, PMED) ~ 1, data = selected_df, nclass = 1)

model_2_classes <- poLCA(cbind(PSEX, CW3_COVID19, CW3_COVID_HOSPAD, CW3_COVNEWILL, 
CW3_FATGRID_1, CW3_FATGRID_2, CW3_FATGRID_3, CW3_FATGRID_4, 
CW3_FATGRID_5, CW3_FATGRID_6, CW3_FATGRID_7, CW3_FATGRID_8, 
CW3_FATGRID_9, CW3_FATGRID_10, CW3_MEMORY, CW3_SKIN, CW3_SHORTB, CW3_PALP, CW3_ACTIVITY, COVIDSYMPT_1, COVIDSYMPT_2, COVIDSYMPT_3, COVIDSYMPT_4, COVIDSYMPT_5, COVIDSYMPT_6, 
COVIDSYMPT_7, COVIDSYMPT_8, COVIDSYMPT_18, 
COVIDSYMPT_10, COVIDSYMPT_11, COVIDSYMPT_12, 
COVIDSYMPT_16, COVIDSYMPT_13, COVIDSYMPT_14, 
COVIDSYMPT_17, COVIDSYMPT_19, COVIDSYMPT_20, 
COVIDSYMPT_23, GHQPRECOVID_pre, LLI_17_pre, OUTDOORS_4_pre, FINANCIALMANB_pre, SMOKING_pre, VAPE_pre, ALDRPP_pre, FINANCIALMAND_post, ALDRSP_post, MHNOW_post, PMED) ~ 1, data = selected_df, nclass = 2)

model_3_classes <- poLCA(cbind(PSEX, CW3_COVID19, CW3_COVID_HOSPAD, CW3_COVNEWILL, 
CW3_FATGRID_1, CW3_FATGRID_2, CW3_FATGRID_3, CW3_FATGRID_4, 
CW3_FATGRID_5, CW3_FATGRID_6, CW3_FATGRID_7, CW3_FATGRID_8, 
CW3_FATGRID_9, CW3_FATGRID_10, CW3_MEMORY, CW3_SKIN, CW3_SHORTB, CW3_PALP, CW3_ACTIVITY, COVIDSYMPT_1, COVIDSYMPT_2, COVIDSYMPT_3, COVIDSYMPT_4, COVIDSYMPT_5, COVIDSYMPT_6, 
COVIDSYMPT_7, COVIDSYMPT_8, COVIDSYMPT_18, 
COVIDSYMPT_10, COVIDSYMPT_11, COVIDSYMPT_12, 
COVIDSYMPT_16, COVIDSYMPT_13, COVIDSYMPT_14, 
COVIDSYMPT_17, COVIDSYMPT_19, COVIDSYMPT_20, 
COVIDSYMPT_23, GHQPRECOVID_pre, LLI_17_pre, OUTDOORS_4_pre, FINANCIALMANB_pre, SMOKING_pre, VAPE_pre, ALDRPP_pre, FINANCIALMAND_post, ALDRSP_post, MHNOW_post, PMED) ~ 1, data = selected_df, nclass = 3)

model_4_classes <- poLCA(cbind(PSEX, CW3_COVID19, CW3_COVID_HOSPAD, CW3_COVNEWILL, 
CW3_FATGRID_1, CW3_FATGRID_2, CW3_FATGRID_3, CW3_FATGRID_4, 
CW3_FATGRID_5, CW3_FATGRID_6, CW3_FATGRID_7, CW3_FATGRID_8, 
CW3_FATGRID_9, CW3_FATGRID_10, CW3_MEMORY, CW3_SKIN, CW3_SHORTB, CW3_PALP, CW3_ACTIVITY, COVIDSYMPT_1, COVIDSYMPT_2, COVIDSYMPT_3, COVIDSYMPT_4, COVIDSYMPT_5, COVIDSYMPT_6, 
COVIDSYMPT_7, COVIDSYMPT_8, COVIDSYMPT_18, 
COVIDSYMPT_10, COVIDSYMPT_11, COVIDSYMPT_12, 
COVIDSYMPT_16, COVIDSYMPT_13, COVIDSYMPT_14, 
COVIDSYMPT_17, COVIDSYMPT_19, COVIDSYMPT_20, 
COVIDSYMPT_23, GHQPRECOVID_pre, LLI_17_pre, OUTDOORS_4_pre, FINANCIALMANB_pre, SMOKING_pre, VAPE_pre, ALDRPP_pre, FINANCIALMAND_post, ALDRSP_post, MHNOW_post, PMED) ~ 1, data = selected_df, nclass = 4)

# Compare AIC and BIC values
aic_values <- c(model_1_class$aic, model_2_classes$aic, model_3_classes$aic, model_4_classes$aic)
bic_values <- c(model_1_class$bic, model_2_classes$bic, model_3_classes$bic, model_4_classes$bic)

# Print the AIC and BIC values
data.frame(N_Classes = 1:4, AIC = aic_values, BIC = bic_values)

```
Lowest AIC value for 4 classes and lowest BIC value for 3 classes. 

## Visualize class proportions
```{r}
class_proportions <- lca_model$P
pie(class_proportions, labels = paste("Class", 1:length(class_proportions), ":", round(class_proportions * 100, 1), "%"),
    main = "Latent Class Proportions")
```

Based on the result from fitting 3 latent classes on people diagonised with long covid, all three classes have more female than male, and the majority of individuals in all three classes did not go to the hospital because of coronavirus. Class 3 has the highest proportion of individuals diagnosed with COVID-19, followed by Class 2, where approximately half of the individuals were diagnosed, and Class 1, with the fewest diagnosed cases. 

Class 3 individuals are more likely to report feeling tired at the time of the survey, while Class 2 individuals experience occasional tiredness, and Class 1 individuals are less likely to report fatigue. Similarly, Class 3 respondents exhibit the worst memory compared to the other two classes.

While the majority of individuals in all three classes did not experience skin problems, Class 3 experienced more shortness of breath, racing heart, and more restriction on daily activities. 

In terms of specific covid symptoms, Class 3 individuals experience more frequent sore throat, chest tightness, shortness of breath, runny nose, body aches, fatigue, sneezing, and headaches. Class 2 individuals report more shortness of breath, body aches, fatigue, and headaches. In contrast, Class 3 individuals report fewer symptoms overall.

Overall, Class 3 individuals are characterized by experiencing multiple symptoms, Class 2 by mild symptoms, and Class 1 by generally less severe symptoms. The class proportion indicates that most of the respondents are characterized with mild symptoms, followed by Class 3 respondents and Class 1 respondents.

