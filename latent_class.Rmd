---
title: "Latent Class Analysis"
---

# Load library
```{r}
library(poLCA)
library(dplyr)
library(openxlsx)
library(ggplot2)
library(tidyr)
library(purrr)
```

# Load data
```{r}
df <- read.xlsx("final_merged_generalised_dataset.xlsx")

head(df)
```
# Analysis of all individuals

## Check the number of null values
```{r}
colSums(is.na(df))
```

## Remove predictors
```{r}
# remove numerical or predictors with too many missing values
df <- df[, !(names(df) %in% "ID")]
df <- df[, !(names(df) %in% "RELSAT")]
df <- df[, !(names(df) %in% "GROWB2_post")]
df <- df[, !(names(df) %in% "CW3_GROWB2")]
df <- df[, !(names(df) %in% "FINAL_WGHT")]
df <- df[, !(names(df) %in% "HSLEEPPP_pre")]
df <- df[, !(names(df) %in% "HSLEEPSP_post")]
df <- df[, !(names(df) %in% "WRKHOURSB_pre")]
df <- df[, !(names(df) %in% "WRKHOURSD_post")]
df <- df[, !(names(df) %in% "HHNUM")]
df <- df[, !(names(df) %in% "NUMROOMS")]
df <- df[, !(names(df) %in% "NUMCIGSPP_pre")]
df <- df[, !(names(df) %in% "NUMCIGSSP_post")]
df <- df[, !(names(df) %in% "EXCISEPP_pre")]
df <- df[, !(names(df) %in% "EXCISESP_post")]
df <- df[, !(names(df) %in% "FRTVEGPP_pre")]
df <- df[, !(names(df) %in% "FRTVEGSP_post")]
df <- df[, !(names(df) %in% "CW3_COVID19POS")]
df <- df[ , !grepl("TIREDGRID", names(df))]
df <- df[ , !grepl("COVNEWILT", names(df))]

colSums(is.na(df))
```

## Replace or turn missing values into a factor
```{r}
# set missing values for number of cigarettes as 0
df$NUMCIGSPP_pre[is.na(df$NUMCIGSPP_pre)] <- 0
df$NUMCIGSSP_post[is.na(df$NUMCIGSSP_post)] <- 0

# convert NA to a missing level
fatgrid_vars <- grep("FATGRID", names(df), value = TRUE)

vars_to_convert <- c("CW3_COVNEWILL", "CW3_BEENVAC", "GHQ", "PMED", "CW3_ECONACTIVITYB2", "GHQPRECOVID_pre", "LLI_17_pre", "OUTDOORS_4_pre", "FINANCIALMANB_pre", "ECONACTIVITYB_pre", "SMOKING_pre", "VAPE_pre", "ALDRPP_pre", "FINANCIALMAND_post", "ECONACTIVITYD_post", "VAPESP_post", "ALDRSP_post", "SATN_post", "MHNOW_post", "CW3_SHORTB", "CW3_PALP", "CW3_ACTIVITY", "CW3_MEMORY", "CW3_SKIN")

vars_to_convert <- c(vars_to_convert, fatgrid_vars)

for (var in vars_to_convert) {
  df[[var]] <- factor(df[[var]], exclude = NULL)
  levels(df[[var]])[is.na(levels(df[[var]]))] <- "Missing"
}

# check unique values
lapply(df, unique)
```

## Check the number of missing values
```{r}
colSums(is.na(df))
```


## Check dimension
```{r}
df_selected <- df
df_selected <- df_selected[, !(names(df_selected) %in% "longcov")]

head(df_selected)
dim(df_selected)
```

## Convert all remaining variables to factors
```{r}
df_selected[] <- lapply(df_selected, as.factor)

sapply(df_selected, class)
lapply(df_selected, unique)
```

## Compare AIC and BIC values for different number of classes
```{r}
# Build the formula for the list of predictors
lca_formula <- as.formula(
  paste("cbind(", paste(names(df_selected), collapse = ","), ") ~ 1")
)

lca_models <- list()
aic_values <- numeric()
bic_values <- numeric()

# Loop over number of classes 1 to 10
for (nclass in 1:6) {
  cat("Running model with", nclass, "classes...\n")
  
  model <- poLCA(lca_formula, data = df_selected, nclass = nclass, verbose = FALSE, nrep = 10)  # nrep=10 for better stability
  lca_models[[nclass]] <- model
  aic_values[nclass] <- model$aic
  bic_values[nclass] <- model$bic
}

# Combine AIC and BIC results in a dataframe
results_df <- data.frame(
  N_Classes = 1:6,
  AIC = aic_values,
  BIC = bic_values
)

print(results_df)
```
lowest AIC and BIC value for 6 clusters

# LCA model for all individuals
```{r}
lca_all <- poLCA(lca_formula, data = df_selected, nclass = 4, verbose = FALSE, nrep = 10)

summary(lca_all)
lca_all$probs
```

## Visualize class proportions for all individuals
```{r}
class_proportions <- lca_all$P
pie(class_proportions, labels = paste("Class", 1:length(class_proportions), ":", round(class_proportions * 100, 1), "%"),
    main = "Latent Class Proportions for All Individuals")
```
## Check frequency of long covid across LCA classes
```{r}
df_selected$LCA_class <- lca_all$predclass

table(df_selected$LCA_class, df$longcov)
prop.table(table(df_selected$LCA_class, df$longcov), 1)
```
## Bar plot of long covid distriubtion
```{r}
# Create a summary table
df_summary <- as.data.frame(prop.table(table(df_selected$LCA_class, df$longcov), 1))
colnames(df_summary) <- c("LCA_class", "long_covid", "proportion")

# Plot
ggplot(df_summary, aes(x = LCA_class, y = proportion, fill = long_covid)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Proportion of Long COVID by LCA Class",
       x = "LCA Class",
       y = "Proportion",
       fill = "Long COVID") +
  theme_minimal()
```

## Chi-square test
```{r}
chisq.test(table(df_selected$LCA_class, df$longcov))
```
